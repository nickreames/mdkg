{
  "meta": {
    "root": "root:task-1",
    "depth": 2,
    "verbose": false,
    "generated_at": "2026-01-14T03:13:06.122Z",
    "node_count": 12,
    "truncated": {
      "max_nodes": false,
      "max_bytes": false,
      "dropped": []
    }
  },
  "nodes": [
    {
      "qid": "root:task-1",
      "id": "task-1",
      "workspace": "root",
      "type": "task",
      "title": "claim npm name and bootstrap publish safety",
      "status": "done",
      "priority": 0,
      "path": ".mdkg/work/task-1-claim-npm-name-and-bootstrap-publish-safety.md",
      "frontmatter": {
        "links": [
          "npm:mdkg"
        ],
        "artifacts": [
          "publish-whitelist",
          "tarball-verified",
          "bin-wired"
        ]
      },
      "body": "\n# Overview\n\nEnsure the npm package name `mdkg` is claimed and publishing is configured so only safe artifacts are shipped (no `.mdkg/` content).\n\n# Acceptance Criteria\n\n- npm account is configured and able to publish packages\n- `package.json` uses \"files\" whitelist to publish only `dist/`, `README.md`, `LICENSE`\n- optional `.npmignore` added as a belt-and-suspenders safety measure\n- `npm pack` output does not include `.mdkg/` or any index files\n- `mdkg` binary is installable and runs (`mdkg --help`)\n\n# Files Affected\n\n- package.json\n- README.md\n- LICENSE\n- .npmignore (optional)\n- .gitignore\n\n# Implementation Notes\n\n- Prefer \"files\" whitelist over ignore blacklists.\n- Ensure `bin` points to `dist/cli.js` (compiled JS) and file has a node shebang.\n- Confirm `engines.node >=18`.\n\n# Test Plan\n\n- run `npm pack` and inspect tarball contents\n- install locally from tarball to verify bin works\n\n# Links / Artifacts\n\n- rule-4 (repo safety)\n- rule-5 (release and versioning)"
    },
    {
      "qid": "root:epic-1",
      "id": "epic-1",
      "workspace": "root",
      "type": "epic",
      "title": "v1 bootstrap and npm publish",
      "status": "progress",
      "priority": 1,
      "path": ".mdkg/work/epic-1-v1-bootstrap-and-npm-publish.md",
      "frontmatter": {
        "links": [
          "npm:mdkg"
        ],
        "refs": [
          "rule-1",
          "rule-2",
          "rule-3",
          "rule-4",
          "rule-5",
          "rule-6"
        ]
      },
      "body": "\n# Goal\n\nShip mdkg v1 as a usable CLI (Node 18+, TypeScript, zero runtime deps) with:\n\n- root-only operation\n- registered workspaces\n- global indexing + search\n- deterministic context packs\n- validation + formatting\n- next (chain + priority)\n- checkpoints\n- published to npm\n\n# Scope\n\nIncluded:\n\n- repo scaffolding (package.json, tsconfig, src layout)\n- `.mdkg` rules/design docs/templates/work items (dogfooding)\n- CLI commands for v1\n- npm publish safety (files whitelist)\n- minimal smoke tests / scripts\n\nExcluded (explicitly deferred):\n\n- sqlite/postgres indexing (life git layer)\n- per-workspace template overrides\n- UI application\n- external integrations (MCP server, etc.)\n\n# Milestones\n\n- M1: repo + build pipeline + CLI skeleton\n- M2: config + workspace registry + strict frontmatter parser\n- M3: indexer + global cache + search/list/show\n- M4: pack (md/json/toon) + verbose core inclusion\n- M5: validate + format\n- M6: next (chain + priority)\n- M7: checkpoints and pack integration\n- M8: publish v1 to npm + create checkpoint\n\n# Risks\n\n- Strict frontmatter means small mistakes can block indexing (mitigated by `mdkg format` and clear errors)\n- Zero runtime dependencies increases implementation burden (keep scope tight)\n- Pack determinism and ordering must be consistent (centralize ordering logic)\n\n# Links / Artifacts\n\nCore rules:\n\n- rule-1\n- rule-2\n- rule-3\n- rule-4\n- rule-5\n- rule-6\n\nDesign:\n\n- edd-1\n- dec-1\n- dec-2\n- dec-3\n- dec-4\n- dec-5\n- dec-6\n- dec-7\n\nNext tasks:\n\n- task-1\n- task-2\n- task-3"
    },
    {
      "qid": "root:edd-1",
      "id": "edd-1",
      "workspace": "root",
      "type": "edd",
      "title": "mdkg cli and index architecture (v1)",
      "path": ".mdkg/design/edd-1-mdkg-cli-and-index-architecture.md",
      "frontmatter": {},
      "body": "\n# mdkg CLI and index architecture (v1)\n\n## Overview\n\nmdkg is a **TypeScript** CLI targeting **Node 18+** with **zero runtime dependencies**.\n\nIt manages a local Markdown knowledge graph stored across:\n- the root workspace: `./.mdkg/`\n- registered subdirectory workspaces: `<workspace>/.mdkg/` (docs live near code)\n\nThe CLI operates at repo root using:\n- `.mdkg/config.json` as canonical configuration\n- `.mdkg/index/global.json` as the authoritative cached index\n\nKey goals:\n- deterministic behavior\n- fast search and traversal\n- strict frontmatter parsing\n- powerful context pack generation\n\n## Root-only flow\n\nAll commands assume they are invoked from the repo root unless `--root` is provided.\n\nRoot validity check:\n- `./.mdkg/config.json` must exist\n- if missing: error with instructions (or suggest `mdkg init`)\n\n## Configuration\n\nConfig lives at:\n- `./.mdkg/config.json`\n\nIt includes:\n- `schema_version`\n- workspace registry\n- index settings (auto reindex, tolerant mode)\n- pack defaults and limits\n- global templates location and default set\n- work enums (status, priority bounds)\n\nConfig loading:\n- strict validation of required keys\n- schema migrations supported via version upgrade functions\n\n## Workspace registry\n\nWorkspaces are explicit in config:\n- alias → `{ path, enabled, mdkg_dir }`\n\nRules:\n- aliases are lowercase and unique\n- paths are relative to repo root\n- `mdkg_dir` defaults to `.mdkg`\n\nDocs live near code:\n- workspace docs are in `<workspace_path>/.mdkg/...`\n\nNo runtime discovery:\n- only configured workspaces are indexed and searched\n- indexing scans registered workspace doc roots\n\n## Indexing\n\n### Source locations\n\nIndex inputs include:\n- root `.mdkg/core|design|work` markdown files\n- each workspace’s `.mdkg/core|design|work` markdown files\n\nTemplates are **not indexed** as nodes.\n\n### Frontmatter parsing\n\nFrontmatter uses a restricted subset (see rule-1 and rule-6). Parsing must be strict.\n\nOn invalid frontmatter:\n- default indexing fails (exit code 2 or 4 depending on implementation)\n- optional tolerant mode skips invalid nodes and continues with warnings\n\n### Node model\n\nEach markdown file becomes a node:\n- `id`, `type`, `title`, `created`, `updated`\n- optional searchable metadata: `tags`, `owners`, `links`, `artifacts`, `refs`, `aliases`\n- work metadata: `status`, `priority`\n- graph edges: `epic`, `parent`, `relates`, `blocked_by`, `blocks`, `prev`, `next`\n- note: `refs` is a searchable reference list but is NOT traversed by default pack traversal\n- note: `links` and `artifacts` store any searchable reference strings (may include URLs)\n\n### Global uniqueness and qualified IDs\n\nIn the global index, every node has:\n- `qid = <ws_alias>:<id>`\n- `ws = <ws_alias>`\n- `path = relative path to markdown file`\n\nEdges are normalized to qualified IDs internally:\n- local edge references without `ws:` are assumed to be in the same workspace as the node\n- qualified edges (`ws:id`) resolve across workspaces\n\nAmbiguity handling:\n- if a qualified reference cannot be resolved: validation error\n- if a user queries an unqualified ID that exists in multiple workspaces: CLI errors and suggests qualified IDs\n\n### Index output format (global.json)\n\nRoot index output path:\n- `./.mdkg/index/global.json`\n\nRecommended structure:\n\n- `meta`:\n  - tool version\n  - schema_version\n  - generated_at\n  - root path\n  - included workspaces\n- `workspaces`:\n  - alias → `{ path, enabled }`\n- `nodes`:\n  - `qid` → node record:\n    - `id`, `qid`, `ws`, `type`, `title`, `status`, `priority`, `created`, `updated`, `tags`, `owners`, `links`, `artifacts`, `refs`, `aliases`, `path`\n    - `edges` (qualified)\n- `reverse_edges`:\n  - precomputed reverse adjacency by edge type for fast queries:\n    - children of epic\n    - blocked graph\n    - prev/next chain linkers\n- `aliases` (optional):\n  - numeric ID counters or convenience lookups\n\n## Staleness and auto reindex\n\nDefault behavior:\n- commands requiring graph data check if `global.json` is stale:\n  - global missing → stale\n  - config mtime newer than global → stale\n  - any `*.md` in registered `.mdkg/` docs folders newer than global → stale\n\nIf stale:\n- auto rebuild index unless `--no-reindex` or config disables auto reindex\n\nv1 keeps this simple using file mtimes. A file manifest may be introduced later if performance demands it.\n\n## Commands architecture\n\nImplementation approach:\n- `src/cli.ts` routes to `src/commands/*.ts`\n- shared logic in `src/core`, `src/graph`, `src/templates`, `src/pack`\n\nEach command should:\n1) enforce root (or resolve `--root`)\n2) load config (migrate if needed)\n3) ensure index ready (auto reindex if stale)\n4) perform action\n5) output deterministically\n6) exit with stable code per rule-3\n\n## Packs architecture\n\nPack generation uses:\n- global index nodes/edges\n- BFS traversal with configurable depth and edge selection\n- deterministic ordering (rule-2)\n- `--verbose` includes pinned core docs from `.mdkg/core/core.md`\n- pack node headers must surface key searchable fields (at minimum: `links` and `artifacts`, plus `refs` when present)\n\nExports:\n- Markdown (human/agent)\n- JSON (programmatic agent)\n- TOON (agent / structured)\n\nPacks must enforce limits and record truncation metadata.\n\n## Validation\n\nValidation checks:\n- strict frontmatter parsing\n- required fields present by type (rule-6)\n- status/priority enums valid\n- edges resolve to existing nodes\n- cycles in `prev/next` chains (warn or error; v1 recommend error for cycles)\n- duplicate IDs in a workspace (error)\n- ambiguous unqualified IDs for user queries (CLI error, not index error)\n\n## Formatting\n\nFormatting is conservative:\n- normalizes frontmatter output format (key order, list formatting)\n- enforces lowercase for keys and enums\n- leaves body content unchanged where possible\n- may normalize newline endings\n\n## Security and publish safety\n\n- `.mdkg/index/` is generated and must be gitignored\n- npm package publishes only `dist/`, `README.md`, `LICENSE` via `files` whitelist\n- `.mdkg/` docs never published in npm package"
    },
    {
      "qid": "root:dec-1",
      "id": "dec-1",
      "workspace": "root",
      "type": "dec",
      "title": "config schema versioning and migrations",
      "status": "accepted",
      "path": ".mdkg/design/dec-1-config-schema-and-migrations.md",
      "frontmatter": {},
      "body": "\n# Context\n\nmdkg stores repo-wide settings in `.mdkg/config.json`. This file is “data” that must remain usable across versions of the CLI.\n\nWithout versioning, early changes would break existing repos and make upgrades painful.\n\n# Decision\n\n- `.mdkg/config.json` includes a required integer: `schema_version`\n- mdkg includes deterministic migration functions to upgrade older schemas to the latest schema\n- migration strategy is “stepwise”:\n  - N → N+1 transforms only\n  - repeat until latest\n- migrations must be safe and transparent:\n  - trivial renames may auto-migrate on load\n  - behavior-changing migrations may require explicit `mdkg config migrate` in the future\n\n# Alternatives considered\n\n- No versioning (reject): breaks existing repos quickly\n- “Loose” versioning without migrations (reject): pushes work to users and creates drift\n- External migration frameworks (reject): violates zero runtime dependencies\n\n# Consequences\n\n- The CLI must maintain migration code for older versions\n- Config shape becomes a stable contract and supports future tools (including life git ingestion)"
    },
    {
      "qid": "root:dec-2",
      "id": "dec-2",
      "workspace": "root",
      "type": "dec",
      "title": "root-only operation and registered workspaces (no discovery)",
      "status": "accepted",
      "path": ".mdkg/design/dec-2-root-only-and-registered-workspaces.md",
      "frontmatter": {},
      "body": "\n# Context\n\nWe want deterministic behavior and fast operation. Runtime “workspace discovery” adds complexity and uncertainty.\n\nWe also want support for multiple workspaces (subdirectories) with docs near code, indexed globally.\n\n# Decision\n\n- mdkg is run at the repo root by default (or via `--root`)\n- `.mdkg/config.json` defines a workspace registry\n- only registered workspaces are indexed and searched\n- workspaces store docs near code at `<workspace>/.mdkg/...`\n- the root index contains the authoritative global index across workspaces\n\n# Alternatives considered\n\n- Walk up directories from cwd to find nearest workspace (reject): nondeterministic for global operations\n- Implicit discovery of workspaces by scanning for `.mdkg` folders (reject): surprises users and slows commands\n\n# Consequences\n\n- Users must add workspaces explicitly via config/CLI\n- Indexing is predictable and bounded to known directories\n- All commands can default to global behavior with easy filtering"
    },
    {
      "qid": "root:dec-3",
      "id": "dec-3",
      "workspace": "root",
      "type": "dec",
      "title": "cache is default and commands auto reindex when stale",
      "status": "accepted",
      "path": ".mdkg/design/dec-3-cache-default-and-auto-reindex.md",
      "frontmatter": {},
      "body": "\n# Context\n\nGraph search and traversal should be fast even as documentation grows. A cache/index is required for good UX.\n\nWe also want low friction for humans and agents; stale caches should not cause confusing behavior.\n\n# Decision\n\n- caching is enabled by default\n- authoritative global cache path: `.mdkg/index/global.json`\n- commands that require graph data automatically rebuild the index when stale\n- a manual command exists: `mdkg index`\n- strict indexing is default; tolerant mode is an escape hatch\n\n# Alternatives considered\n\n- no cache (reject): slow scanning and parsing on every command\n- cache optional default-off (reject): encourages slow, inconsistent usage\n- require manual index always (reject): too easy to forget, poor agent UX\n\n# Consequences\n\n- index rebuild must be reliable and deterministic\n- staleness detection must be correct (config and markdown mtimes)\n- index path must remain gitignored and safe"
    },
    {
      "qid": "root:dec-4",
      "id": "dec-4",
      "workspace": "root",
      "type": "dec",
      "title": "strict frontmatter and flexible body structure",
      "status": "accepted",
      "path": ".mdkg/design/dec-4-frontmatter-strict-body-flexible.md",
      "frontmatter": {},
      "body": "\n# Context\n\nThe knowledge graph and search depend on parsing frontmatter reliably. LLM agents may sometimes create malformed structures in document bodies.\n\nWe need strictness where it matters and flexibility where it does not.\n\n# Decision\n\n- frontmatter must follow the restricted subset and is strictly validated\n- invalid frontmatter breaks indexing by default\n- document body structure is guided by templates but not strictly enforced\n- validator warns on missing recommended headings but does not break indexing\n\n# Alternatives considered\n\n- enforce full markdown schema with strict headings (reject): too brittle for humans/agents\n- allow “best effort” frontmatter parsing (reject): leads to silent corruption of graph\n\n# Consequences\n\n- `mdkg validate` must clearly report frontmatter violations\n- `mdkg format` should help repair common frontmatter formatting issues\n- templates become important for agent usability"
    },
    {
      "qid": "root:dec-5",
      "id": "dec-5",
      "workspace": "root",
      "type": "dec",
      "title": "global templates only (root templates)",
      "status": "accepted",
      "path": ".mdkg/design/dec-5-global-templates-only.md",
      "frontmatter": {},
      "body": "\n# Context\n\nPer-workspace template overrides add complexity. v1 should remain simple and consistent.\n\nWe still want strong templating to support agent workflows.\n\n# Decision\n\n- templates are global only and live at `.mdkg/templates/<set>/<type>.md`\n- workspace template overrides are disabled in v1\n- template sets are supported (default/minimal/verbose)\n- templates are filled via token substitution only (no template engine dependencies)\n\n# Alternatives considered\n\n- workspace overrides (defer): revisit when v1 is stable\n- external template engines (reject): violates zero dependency constraint\n\n# Consequences\n\n- consistent document structure across the repo\n- easier implementation and validation\n- specialization happens via fields/tags/workspace separation, not templates"
    },
    {
      "qid": "root:dec-6",
      "id": "dec-6",
      "workspace": "root",
      "type": "dec",
      "title": "next priority uses chain first then priority (p0..p9)",
      "status": "accepted",
      "path": ".mdkg/design/dec-6-next-mechanisms-chain-and-priority.md",
      "frontmatter": {},
      "body": "\n# Context\n\nWe need an easy “what should I do next?” capability.\n\nTwo complementary patterns exist:\n- explicit curated flow (`prev/next`)\n- triage and ordering (`priority`)\n\n# Decision\n\n- mdkg supports both:\n  - explicit `prev/next` chains for linear progress\n  - `priority: 0..9` for global ordering and triage\n- `mdkg next` uses:\n  1) chain (`next:`) when present and unambiguous\n  2) otherwise priority-based selection among active statuses\n\nPriority meaning:\n- `0` = breaking/urgent\n- `9` = later\n\n# Alternatives considered\n\n- chain only (reject): not enough for non-linear backlogs\n- priority only (reject): lacks explicit linear planning when needed\n\n# Consequences\n\n- index must support fast filtering by status and priority\n- CLI must resolve ambiguity and provide clear suggestions"
    },
    {
      "qid": "root:dec-7",
      "id": "dec-7",
      "workspace": "root",
      "type": "dec",
      "title": "checkpoints (chk) are first-class compression nodes",
      "status": "accepted",
      "path": ".mdkg/design/dec-7-checkpoints-as-compression-nodes.md",
      "frontmatter": {},
      "body": "\n# Context\n\nLong-running projects accumulate many nodes. Packs can become too large and time-consuming for humans and agents.\n\nWe need a way to summarize completed phases while retaining references and verification details.\n\n# Decision\n\n- add `chk-*` nodes as first-class checkpoint records\n- checkpoints summarize a set of work and can serve as context anchors\n- checkpoints are allowed per workspace\n- checkpoint templates include structured sections for summary, scope, verification, and links\n- checkpoints should link to the epic and key docs via edges\n- checkpoints may include a `scope: [id, ...]` frontmatter list when practical\n\n# Alternatives considered\n\n- rely on linking many done tasks (reject): packs become noisy and slow to read\n- external summaries in README/wiki (reject): not graph-connected or pack-aware\n\n# Consequences\n\n- agents can consume checkpoint summaries instead of many individual nodes\n- packs can prefer checkpoints (optional future flag) to reduce size\n- project continuity improves significantly"
    },
    {
      "qid": "root:rule-4",
      "id": "rule-4",
      "workspace": "root",
      "type": "rule",
      "title": "mdkg repo safety (ignore rules, publish safety, deployment safety)",
      "path": ".mdkg/core/rule-4-repo-safety-and-ignores.md",
      "frontmatter": {},
      "body": "\n# Repo safety and ignores\n\nmdkg content may contain sensitive notes and internal project planning. This rule defines how to prevent `.mdkg/` content from leaking into build artifacts, containers, and npm packages.\n\n## Safety goals\n\n- `.mdkg/` must not be shipped to production deployments.\n- `.mdkg/` must not be published to npm.\n- `.mdkg/index/` must never be committed.\n\n## Git ignore requirements\n\nThe repo MUST ignore at minimum:\n\n- `node_modules/`\n- `dist/`\n- `.mdkg/index/`\n\nRecommended `.gitignore` entries:\n- `.mdkg/index/`\n- `.mdkg/index/**`\n\n## npm publish safety (required)\n\nThe npm package MUST publish only the compiled CLI output and essential docs.\n\nRequired approach:\n- Use `package.json` `\"files\"` whitelist to ship only:\n  - `dist/`\n  - `README.md`\n  - `LICENSE`\n\nThis approach is preferred over blacklists.\n\nAdditional belt-and-suspenders:\n- Add `.npmignore` that excludes `.mdkg/` and other repo internals, even if `\"files\"` exists.\n\n## Container and deployment safety (recommended)\n\nIf the repo is containerized:\n- `.dockerignore` SHOULD exclude:\n  - `.mdkg/`\n  - `.mdkg/index/`\n  - `node_modules/`\n  - `dist/` (if built in container)\n  - any other local artifacts\n\nFor application builds:\n- Build tooling SHOULD exclude `.mdkg/` (e.g., tsconfig excludes, bundlers exclude dot-folders).\n\n## mdkg init behavior\n\n`mdkg init` MAY offer optional flags to append ignore entries:\n\n- `--update-gitignore`\n- `--update-npmignore`\n- `--update-dockerignore`\n\nIn v1, mdkg should default to **not** editing user files without an explicit flag.\n\n## Index safety\n\n- `.mdkg/index/` is generated.\n- Index files may contain extracted metadata and could expose sensitive strings.\n- Index files MUST be ignored from git.\n- Index rebuild should be deterministic and safe to regenerate at any time.\n\n## Workspace safety\n\nWorkspace-local `.mdkg/` directories (near code) should follow the same rules:\n- the content is source-of-truth docs (tracked)\n- the workspace-local index folder (if present) should be ignored\n- templates remain global (root) in v1\n\n## Summary checklist\n\n- ✅ `.mdkg/index/` ignored\n- ✅ npm publishes only `dist/`, `README.md`, `LICENSE`\n- ✅ optional `.npmignore` excludes `.mdkg/`\n- ✅ `.dockerignore` excludes `.mdkg/` when applicable"
    },
    {
      "qid": "root:rule-5",
      "id": "rule-5",
      "workspace": "root",
      "type": "rule",
      "title": "mdkg release and versioning (semver, publish checklist)",
      "path": ".mdkg/core/rule-5-release-and-versioning.md",
      "frontmatter": {},
      "body": "\n# Release and versioning\n\nmdkg follows SemVer for CLI stability and long-term compatibility.\n\n## SemVer policy\n\n- MAJOR: breaking CLI contract changes (flags/outputs removed or changed)\n- MINOR: new commands/features that are backwards compatible\n- PATCH: bug fixes and internal refactors with no contract changes\n\nConfiguration and schema versioning:\n- `.mdkg/config.json` contains a `schema_version`.\n- mdkg MUST support migrating older schemas to the current schema in a deterministic way.\n- Backwards compatibility matters more for config and docs than for internal index formats.\n\n## Release artifacts\n\nThe npm package MUST include:\n- `dist/` compiled output\n- `README.md`\n- `LICENSE`\n\nIt MUST NOT include:\n- `.mdkg/` docs\n- `.mdkg/index/`\n- source code (optional; can be included later, but not required)\n\n## Release checklist (v1)\n\n1) Ensure clean working tree\n- no uncommitted changes\n- all `.mdkg/index/` ignored\n\n2) Rebuild and validate\n- run `mdkg index`\n- run `mdkg validate`\n- run a pack smoke test (example):\n  - `mdkg pack task-1 --verbose --out /tmp/mdkg-pack.md`\n\n3) Update version\n- bump `package.json` version (semver)\n\n4) Update changelog (recommended)\n- add a short entry describing changes\n\n5) Build\n- run `npm run build` (or equivalent)\n- confirm `dist/cli.js` exists and is executable as a node script\n\n6) Confirm publish whitelist\n- verify `package.json` `\"files\"` includes only expected files\n- optionally run `npm pack` and inspect tarball contents\n\n7) Publish\n- `npm publish`\n\n8) Tag and push\n- create git tag matching version (example `v0.1.0`)\n- push commits and tags\n\n## Release notes guidance\n\nRelease notes should call out:\n- new commands / flags\n- changes to pack behavior\n- changes to config schema (and how migration behaves)\n- new node types or template changes"
    }
  ]
}